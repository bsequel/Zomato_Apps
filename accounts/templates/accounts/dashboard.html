{% extends 'accounts/base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block nav %}

<li class="nav-item"><a class="nav-link" href="/" style="color: #ffffff;">Home</a></li>

{% if user.is_authenticated %}


<div class="profile" id="profileWrapper">
    <button class="profile-btn" id="profileToggle">JD</button>
    <div class="dropdown" id="profileDropdown">
        <div class="user-info">
            <p>
                <span>üë§</span>
                <strong id="username">John Doe</strong>
                <span class="badge bg-warning text-dark mb-1 px-3 py-1 rounded-pill" id="user-role">viewer</span>
            </p>
            <p style="font-size: 13px; color: rgb(0, 154, 159);">
                <span>
                    <i class="bi bi-envelope"></i>
                </span>
                <span id="user-email" class=" mb-1 px-1 py-1">john.doe@example.com</span>
            </p>
        </div>
        <a class="bw-btn" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right pe-3"></i>Logout</a>
    </div>
</div>
{% else %}

<li class="nav-item">
    <a class="nav-link" href="{% url 'login' %}" style="color: #ffffff;">Login</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'register' %}" style="color: #ffffff;">Register</a>
</li>
{% endif %}
{% endblock %}




{% block content %}


<div class="wrapper container p-5 ">
    <!-- Sidebar -->
    <div class="sidebar collapsed" id="sidebar">
        <!-- <div class="logo-wrapper">
            <img alt="Logo" class="sidebar-logo" src="{% static 'images/logo.avif' %}" />
        </div> -->
        <div class="logo-wrapper">
            <p></p>
        </div>
        <!-- <button class="sidebar-toggle-btn" id="toggleSidebar">
            <i class="bi bi-chevron-double-right" id="toggleIcon">
            </i>
        </button> -->
        <!-- Example divider between user and admin sections -->
        <!-- <a class="nav-link1 active" data-section="cyber-cell" href="#"> -->
        <a class="nav-link1" data-section="cyber-cell" href="#">
            <i class="bi bi-shield-lock">
            </i>
            <span>
                Cyber Cell
            </span>
        </a>
        <!-- <a href="#" class="nav-link1" data-section="blackline-mis">
            <i class="bi bi-graph-up-arrow"></i>
            <span>Blackline MIS</span>
        </a> -->
        <a class="nav-link1" data-section="bank-balance" href="#">
            <i class="bi bi-bank">
            </i>
            <span>
                Updating Bank Balance
            </span>
        </a>
        <a class="nav-link1" data-section="payment-gateways" href="#">
            <i class="bi bi-credit-card-2-front">
            </i>
            <span>
                Payment Gateways
            </span>
        </a>
        <a class="nav-link1" data-section="cams-carvy" href="#">
            <i class="bi bi-diagram-3">
            </i>
            <span>
                Cams Carvy
            </span>
        </a>
        <a class="nav-link1" data-section="monthly-email" href="#">
            <i class="bi bi-envelope-at">
            </i>
            <span>
                Monthly Email to Banks
            </span>
        </a>
        <div class="section-divider">
        </div>
        <div id="adminSection" style="display: none;">
            <a class="nav-link1" data-section="manage-users" href="#">
                <i class="bi bi-people-fill">
                </i>
                <span>
                    Manage Users
                </span>
            </a>
            <!-- <a class="nav-link1" data-section="settings" href="#">
                <i class="bi bi-gear-wide-connected">
                </i>
                <span>
                    Settings
                </span>
            </a> -->
        </div>
        {% if user.is_authenticated %}
        <a href="{% url 'logout' %}">
            <i class="bi bi-box-arrow-left">
            </i>
            <span>
                Logout
            </span>
        </a>
        {% endif %}
    </div>
    <!-- Overlay (for mobile) -->
    <div class="overlay" id="overlay">
    </div>

    <!-- Main Content -->
    <div class="content expanded" id="mainContent">
        <!-- navbar -->

        <!-- Cyber Cell Dashboard Content -->
        <div class="content-section active" id="cyber-cell-content">
            <!-- <h2>
                Welcome,
                <span id="username">
                    User
                </span>
                <span class="" id="activeSection" style="color: rgb(94, 94, 94);">
                    Section
                </span>

            </h2> -->
            <!-- <div class="row g-3 mb-4 ">

                <div class="col-md-6 col-6">
                    <div class="alert alert-secondary border border-danger" id="roleMessage">
                        Access level:
                        <strong>
                            Viewer
                        </strong>
                    </div>
                </div>
                <div class="col-md-6 col-6">
                    <div id="etl" class="alert alert-secondary border border-danger">etl</div>
                </div>
            </div> -->
            <!-- <div class="container" > -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="alert-card-minimal alert-card-etl p-3">
                        <div class="alert-card-label">ETL Status</div>

                        <div id="etl1" class="alert-card-content text-primary">ETL</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- <div class="alert-card-minimal alert-card-access p-3">
                        <div class="alert-card-label">Access Level</div>
                        <div class="alert-card-content text-danger">Viewer</div>
                    </div> -->
                </div>
            </div>
            <!-- </div> -->


            <div class="row g-3 mb-4">

                <!-- Total Cases -->
                <div class="col-md-2 col-6">
                    <div class="card text-center border-0 shadow rounded-4 bg-light">
                        <div class="card-body">
                            <span class="badge bg-purple mb-1 px-3 py-1 rounded-pill">Total Cases</span>
                            <h4 class="text-purple fw-bold mt-2" id="card-total-cases">0</h4>
                        </div>
                    </div>
                </div>

                <!-- Pending -->
                <div class="col-md-2 col-6">
                    <div class="card text-center border-0 shadow rounded-4 bg-light">
                        <div class="card-body">
                            <span class="badge bg-warning text-dark mb-1 px-3 py-1 rounded-pill">Pending</span>
                            <h4 class="text-warning fw-bold mt-2" id="card-pending">0</h4>
                        </div>
                    </div>
                </div>

                <!-- Picked -->
                <div class="col-md-2 col-6">
                    <div class="card text-center border-0 shadow rounded-4 bg-light">
                        <div class="card-body">
                            <span class="badge bg-primary mb-1 px-3 py-1 rounded-pill">Picked</span>
                            <h4 class="text-primary fw-bold mt-2" id="card-picked">0</h4>
                        </div>
                    </div>
                </div>

                <!-- Closed -->
                <div class="col-md-2 col-6">
                    <div class="card text-center border-0 shadow rounded-4 bg-light">
                        <div class="card-body">
                            <span class="badge bg-success mb-1 px-3 py-1 rounded-pill">Closed</span>
                            <h4 class="text-success fw-bold mt-2" id="card-closed">0</h4>
                        </div>
                    </div>
                </div>

                <!-- Fraud ‚Çπ -->
                <div class="col-md-4">
                    <div class="card text-center border-0 shadow rounded-4 bg-light">
                        <div class="card-body">
                            <span class="badge bg-danger mb-1 px-3 py-1 rounded-pill">Total Transaction Amount ‚Çπ</span>
                            <h4 class="text-danger fw-bold mt-2" id="card-fraud-amount">‚Çπ0</h4>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <strong>
                        <i class="bi bi-funnel-fill text-danger">
                        </i>
                        Filters
                    </strong>
                </div>
                <div class="card-body">

                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <select class="form-select" id="status-filter">
                                <option value="">
                                    Select Status
                                </option>
                                <option value="Pending">
                                    Pending
                                </option>
                                <option value="Picked">
                                    Picked
                                </option>
                                <option value="Closed">
                                    Closed
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input class="form-control" id="account-filter" placeholder="Account Number" type="text" />
                        </div>
                        <div class="col-md-3">
                            <input class="form-control" id="reference-filter" placeholder="Reference No" type="text" />
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="month-filter">
                                <option value="">
                                    Select Month
                                </option>
                                <option value="January">
                                    January
                                </option>
                                <option value="February">
                                    February
                                </option>
                                <option value="March">
                                    March
                                </option>
                                <option value="April">
                                    April
                                </option>
                                <option value="May">
                                    May
                                </option>
                                <option value="June">
                                    June
                                </option>
                                <option value="July">
                                    July
                                </option>
                                <option value="August">
                                    August
                                </option>
                                <option value="September">
                                    September
                                </option>
                                <option value="October">
                                    October
                                </option>
                                <option value="November">
                                    November
                                </option>
                                <option value="December">
                                    December
                                </option>
                            </select>
                        </div>
                    </div>
                    <!-- filter 1 js -->
                    <!-- filter 1 js -->
                    <!-- filter 1 -->
                    <!-- filter logic -->
                    <div class="row g-2 align-items-center mb-4">
                        <div class="col-auto">
                            <label class="form-label fw-bold mb-0" for="date-filter-type">
                                Filter by
                            </label>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="date-filter-type">
                                <option value="mail_date">
                                    Mail Date
                                </option>
                                <option value="complaint_date">
                                    Complaint Date
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input class="form-control" id="start-date" type="date" />
                        </div>
                        <div class="col-auto">
                            <span class="fw-bold">
                                to
                            </span>
                        </div>
                        <div class="col-md-3">
                            <input class="form-control" id="end-date" type="date" />
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-dark px-4" id="apply-filters">
                                Apply Filters
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-dark" id="reset-filters">
                                &orarr;
                            </button>
                        </div>
                    </div>
                    <!-- date filter javascript -->
                    <!-- date filter javascript -->
                    <!-- filter logic -->

                </div>
            </div>

            <!-- Data Table Section -->
            <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
            <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" rel="stylesheet" />
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="mb-0">
                        Cyber Crime Cases
                    </h5>
                    <!-- <span class="text-muted">
                        Total: ‚Çπ{{ total_amount }}
                    </span> -->
                </div>
                <div class="card-body p-0">
                    <div class="table-container">

                        <div class="table-responsive table-striped  shadow-sm rounded border">
                            <!-- <table class="table table-hover table-borderless align-middle text-nowrap mb-0" -->
                            <table
                                class="table table-hover table-borderless  shadow-sm rounded-3 border mt-3 align-middle text-nowrap mb-0"
                                id="casesTable">
                                <thead class="bg-light position-sticky top-0 z-1">
                                    <!-- Table Headers -->
                                    <tr class="table-secondary fw-semibold small text-dark">
                                        <th>S.No</th>
                                        <th>Complaint Date</th>
                                        <th>Mail Date</th>
                                        <th>Month</th>
                                        <th>Amount</th>
                                        <th>Ref No</th>
                                        <th>Station</th>
                                        <th>A/c No</th>
                                        <th>Name</th>
                                        <th>Mobile</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Ageing Days</th>
                                        <th>Debited From Bank?</th>
                                        <th>Region</th>
                                        <th>UTR No</th>
                                        <th>UTR Amount</th>
                                        <th>Transaction DateTime</th>
                                        <th>Total Fraudulent Amount</th>
                                        <th>Updated On</th>
                                        <th>Updated By</th>
                                        <th>Pdf File</th>
                                    </tr>
                                    <!-- Filter Row -->
                                    <tr class="filter-row bg-white">
                                        <th><input class="form-control form-control-sm" placeholder="S.No"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" type="date" /></th>
                                        <th><input class="form-control form-control-sm" type="date" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Month"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Amount"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Ref No"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Station"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="A/c No"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Name"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Mobile"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Email"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Status"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Ageing Days"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Debited From Bank?"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Region"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="UTR No"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="UTR Amount"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" type="date" /></th>
                                        <th><input class="form-control form-control-sm"
                                                placeholder="Total Fraudulent Amount" type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Updated On"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="Updated By"
                                                type="text" /></th>
                                        <th><input class="form-control form-control-sm" placeholder="pdf_file"
                                                type="text" /></th>
                                    </tr>


                                </thead>

                                <!-- Table Body -->
                                <tbody class="bg-white">
                                    {% for case in cases %}
                                    <tr>
                                        <td>{{ case.sno }}</td>
                                        <td>{{ case.complaint_date }}</td>
                                        <td>{{ case.mail_date }}</td>
                                        <td>{{ case.mail_month }}</td>
                                        <td>{{ case.amount }}</td>
                                        <td>{{ case.reference_number }}</td>
                                        <td>{{ case.police_station_address }}</td>
                                        <td>{{ case.account_number }}</td>
                                        <td>{{ case.name }}</td>
                                        <td>{{ case.mobile_number }}</td>
                                        <td>{{ case.email_id }}</td>

                                        <!-- Status dropdown -->
                                        <td>

                                        </td>

                                        <td>{{ case.ageing_days }}</td>

                                        <!-- Debit from bank dropdown -->
                                        <td>

                                        </td>

                                        <td>{{ case.region }}</td>
                                        <td>{{ case.utr_number }}</td>
                                        <td>{{ case.utr_amount }}</td>
                                        <td>{{ case.transaction_datetime }}</td>
                                        <td>{{ case.total_fraudulent_amount }}</td>
                                        <td>{{ case.updated_on|date:"Y-m-d H:i" }}</td>
                                        <td>{{ case.updated_by }}</td>
                                        <td>{{ case.pdf_file }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>
                        </div>



                    </div>
                </div>
            </div>
        </div>
        <!-- Other Content-Section (placeholders for the rest, unchanged) -->
        <div class="content-section" id="bank-balance-content">
            <div class="under-development">
                <i class="bi bi-tools">
                </i>
                <h3>
                    Bank Balance Under Development
                </h3>
                <p>
                    This feature is currently under development. Please check back later!
                </p>
                <div class="mt-3">
                    <span class="badge bg-warning text-dark">
                        Coming Soon
                    </span>
                </div>
            </div>
        </div>
        <div class="content-section" id="monthly-email-content">

            <div class="under-development">
                <i class="bi bi-tools">
                </i>
                <h3>
                    Monthly Emails Under Development
                </h3>
                <p>
                    This feature is currently under development. Please check back later!
                </p>
                <div class="mt-3">
                    <span class="badge bg-warning text-dark">
                        Coming Soon
                    </span>
                </div>
            </div>
        </div>
        <div class="content-section" id="payment-gateways-content">
            <div class="under-development">
                <i class="bi bi-tools">
                </i>
                <h3>
                    Payment Gateways Under Development
                </h3>
                <p>
                    This feature is currently under development. Please check back later!
                </p>
                <div class="mt-3">
                    <span class="badge bg-warning text-dark">
                        Coming Soon
                    </span>
                </div>
            </div>
        </div>
        <div class="content-section" id="blackline-mis-content">
            <div class="under-development">
                <i class="bi bi-tools">
                </i>
                <h3>
                    Blackline Under Development
                </h3>
                <p>
                    This feature is currently under development. Please check back later!
                </p>
                <div class="mt-3">
                    <span class="badge bg-warning text-dark">
                        Coming Soon
                    </span>
                </div>
            </div>
        </div>
        <div class="content-section" id="cams-carvy-content">
            <div class="under-development">
                <i class="bi bi-tools">
                </i>
                <h3>
                    Cams Carvy Under Development
                </h3>
                <p>
                    This feature is currently under development. Please check back later!
                </p>
                <div class="mt-3">
                    <span class="badge bg-warning text-dark">
                        Coming Soon
                    </span>
                </div>
            </div>
        </div>
        <div class="content-section" id="manage-users-content">

            <div class="container mt-5">

            </div>


            <h1 class="mb-4">
                Welcome,
                <strong>
                    {{ user.username }}
                </strong>
                <span class="badge bg-secondary">
                    {{ user.role|title }}
                </span>
            </h1>
            {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
            {% endif %}

            {% if user.role == 'admin' %}
            <!-- Create User Button -->
            <button class="btn btn-dark mb-3" data-bs-target="#createUserModal" data-bs-toggle="modal">
                + Create New User
            </button>
            <!-- Download Excel Button -->
            <button class="btn btn-dark mb-3 ms-2" id="downloadExcelBtn">
                ‚¨áÔ∏è Download Excel
            </button>
            <!-- Create User Modal -->

            <div aria-hidden="true" class="modal fade" id="createUserModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content p-4">
                        <div id="create-user-message">
                        </div>
                        <div
                            class="text-center fw-bold p-2 text-lg text-danger fs-4 border border-top-0 border-start-0 border-end-0 border-2 mb-4 border-danger">
                            User Creation Form
                        </div>

                        <form id="create-user-form" method="POST">


                            {% csrf_token %}
                            <div class="mb-3">
                                {{ create_form.username.label_tag }} {{ create_form.username }}
                            </div>
                            <div class="mb-3">
                                {{ create_form.email.label_tag }} {{ create_form.email }}
                            </div>
                            <div class="mb-3">
                                {{ create_form.password1.label_tag }} {{ create_form.password1 }}
                            </div>
                            <div class="mb-3">
                                {{ create_form.password2.label_tag }} {{ create_form.password2 }}
                            </div>
                            <div class="mb-3">
                                {{ create_form.role.label_tag }} {{ create_form.role }}
                            </div>
                            <button class="btn btn-dark" type="submit">
                                Create
                            </button>
                            <button class="btn btn-dark" data-bs-dismiss="modal" type="button">
                                Cancel
                            </button>
                        </form>


                    </div>
                </div>
            </div>
            <!-- User Table -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover bg-white shadow-sm" id="userTable">
                    <thead class="table-light">
                        <tr>
                            <th>
                                Username
                            </th>
                            <th>
                                Email
                            </th>
                            <th>
                                Current Role
                            </th>
                            <th>
                                Change Role
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in users %}
                        <tr id="row-{{ u.id }}">
                            <td>
                                {{ u.username }}
                            </td>
                            <td>
                                {{ u.email }}
                            </td>
                            <td>
                                <span
                                    class="badge {% if u.role == 'admin' %}badge-admin{% else %}badge-viewer{% endif %}"
                                    id="role-badge-{{ u.id }}">
                                    {{ u.role|title }}
                                </span>
                            </td>
                            <td>
                                <select class="form-select form-select-sm"
                                    onchange="updateUserRole('{{ u.id }}', this.value)">
                                    <option %}="" %}selected{%="" endif="" if="" u.role="viewer" value="viewer" {%="">
                                        Viewer
                                    </option>
                                    <option %}="" %}selected{%="" endif="" if="" u.role="admin" value="admin" {%="">
                                        Admin
                                    </option>
                                </select>
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning mt-4">
                You are a
                <strong>
                    {{ user.role }}
                </strong>
                and do not have permission to manage users.
            </div>
            {% endif %}
        </div>
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer">
        </div>

        <!-- DataTables JS + Buttons for Excel export -->


        <!-- Manage Users -->
    </div>
    <div class="content-section" id="under-development-content">
        <div class="under-development">
            <i class="bi bi-tools">
            </i>
            <h3>
                Under Development
            </h3>
            <p>
                This feature is currently under development. Please check back later!
            </p>
            <div class="mt-3">
                <span class="badge bg-warning text-dark">
                    Coming Soon
                </span>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Sidebar Toggle Script -->





<!-- filters js -->
{% endblock %}